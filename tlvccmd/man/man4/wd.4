.TH WD 4
.SH NAME
wd0 \- Driver for the wd/smc 8003/8013/8x16 ISA Ethernet controller family
.SH SYNOPSIS
.nf
wd8003, wd8013, smc8x16
	/bootopts: wd0=11,0x300,0xcc00,0x80
	/dev/wd0 - major: 9 minor: 1
.fi
.SH DESCRIPTION
The \fBwd0\fP 
device refers to the TLVC driver for the WD/SMC family of 10Mbps shared memory 
Ethernet interfaces (aka NICs) running on the PC ISA 8 or 16 bit bus. The 
\fBwd8013\fP
and later models have a full width 16 bit (double) edge connector an may
be used in 16 or 8 bit modes. The
.B wd8003
has a single, 8bit wide edge connector and is an 8 bit only device.
.PP
The driver will attempt to recognize the type of controller and bus width, and 
adjust settings accordingly. That includes setting the buffer size, either 8k or 16k bytes.
The actual settings will be displayed at boot time. If environment autodetection does not work, all settings
may be overridden via the flags-parameter in the
.I /bootopts
file.
.PP
Any of these NIC models should work in any ISA based PC. However, due to technical restrictions
in the ISA bus, 8-bit and 16-bit shared memory devices cannot be located in the same 128k address region.
This means that the 8-bit 8003 model in many cases will create havoc in ISA-16 based systems. In recent day ISA
 based PCs, advanced (very 'helpful') BIOSes may prevent this combination to work at all, in some cases not even boot.
.SH CONFIGURATION
The default settings for the interface are set in the
.I ports.h 
file in the TLVC source tree, see the FILES section below. These settings may conveniently
be overridden at boot-time via the
.I /bootopts
file using the syntax shown in the SYNOPSIS section above.
.PP
The first parameter is the IRQ (decimal), 
the second is the base I/O port address (in hexadecimal), the third is the shared memory
segment address (also hexadecimal) and the fourth is the 
\fIflag\fP
field described below. Any of the parameters may be omitted and the defaults from 
.I ports.h
will be used. The commas must be kept.
.SH FLAGS
The 
.I flags 
part of the configuration line enables/disables various interface and driver parmeters at boot time.
These parameters vary slightly from one interface type/vendor to the next, so make sure to 
look at the correct man page to get correct information.
.PP
The defaults are:
.nf
	Bus width:	Autodetect
	Buffer size:	Autodetect
	Verbose msgs:	On
	Shared mem seg: 0xcc00
.fi
.PP
As distributed, the settings in the 
.I /bootopts
file set the verbose flag (0x80) in the flags field to aid debugging.
.PP
.nf
	NAME		VALUE	FUNCTION
	ETHF_8BIT_BUS   0x10    Force  8 bit bus
	ETHF_16BIT_BUS  0x20    Force 16 bit bus
	ETHF_VERBOSE    0x80    Turn on console error messages
	ETHF_4K_BUF	0x04	Force 4k buffer size
	ETHF_8K_BUF	0x01	Force 8k buffer size
	ETHF_16K_BUF	0x02	etc.
	ETHF_32K_BUF	0x03

.fi
Forcing a larger buffer than what's available on the NIC will cause interesting (and rather obvious) problems. 
Choosing a smaller buffer has no effect other than increasing the chances of overruns and
decreasing performance.
.SH TROUBLESHOOTING
When the \fBwd0\fP
interface has been configured into the running kernel via
\fImenuconfig\fP,
a boot message will indicate whether the configuration works or not.
The following message indicates success:
.PP
.nf
eth: wd0 at 0x320, irq 11, ram 0xcc00, wd8013/16k MAC 00:00:C0:BC:8F:4B, 
						flags 0x80
.fi
.PP
The interface was found at the specified I/O address, the shared memory address and
the displayed MAC (Ethernet) address were set, but not tested. 
That testing comes when 
.I ktcp
has been started and the NIC is connected to the network.
If at this point the console is displaying a lot of 'Damaged packet, hdr ...´ messages, the
shared memory address is wrong or overlapping with something else, like BIOS code or shared
memory on another interface.
.PP
If you get occasional - like every 10th or 20th packet - 'Damaged packet´ errors, the NIC buffer is smaller
than the driver thinks it is. Adjust this using the flags (see below). This may also happen if a
.I wd8013
NIC is used in a XT class (8bit ISA bus) system, a combintaion which requires the buffer size to be manually (via /bootopts)
reduced to 8k.
.PP 
If the interface does 
not seem to work or works on an off, a few packets at a time, the IRQ may be wrong or possibly taken by another card.
While the OS will prevent two interfaces from allocating the same IRQ, a collission may still happen if
two interfaces configured to the same IRQ are installed in the system. See below about changing settings on the NIC itself.
.PP
An IRQ issue may be tested by trying an outgoing 
.I telnet
command to some other host. Sending packets doesn't need interrupts to work, and when sending, the driver 
will collect incoming packets 'while at it' so to speak. Thus,
an outgoing 
.I telnet
connection will enable traffic to flow, even for other connections, for as long as the user is typing at the keyboard.
.PP 
If the interface has several connection options (AUI, BNC and/or TP), this may also be the source
of the problem. The card may need to 
be configured specifically for the connection type in use. The driver does not provide
options to set the connection type, use the DOS configuration tool for that (se below).
.PP
If the interface is reported as 'not found' it is likely that the I/O address is incorrect. 
Use the DOS
.I EZSETUP
program to configure jumperless cards.
Also make sure that the shared
memory address is not used by other ISA interfaces.
.PP
If the interface seems to work  or partly work but emit error messages while 
transferring data, make sure you set the
.I verbose
flag in the 
.I /bootopts 
configuration to get as much detail as possible about what's going on. 
Refer to the FLAGS and ERROR MESSAGES sections
for details.
.SH DIAGNOSTICS
The driver may emit the following error messages, some of them only if the verbose flag has been set.
.PP
.nf
\fIwd0: Damaged packet, hdr 0x%x %u, buffer cleared\fR
.fi
A damaged packet was found in the NICs buffer and is discarded, which will cause a retransmit
if the packet was part of a TCP session. Since the NIC is programmed to discard 
erroneous packets automatically, this should not happen, and may - if it happens 
more than once - indicate a hardware malfunction.
.PP
.nf
\fIeth: mismatched read page pointers %2x vs %2x.\fR
.fi
This should never happen and indicates either a driver bug or a physical hardware problem.
Contact the TLVC support community if you see this error.
.PP
.nf
\fIwd0: Rcv oflow (0x%x), keep %d\fR
.fi
The interface was unable to handle the amount of incoming traffic and had to 
discard one or more packets.
Since incoming packets are transferred directly from the interface buffer to user space,
with no buffering by the operating system, this may occur regularly when under heavy load. 
If it happens in light load conditions, it may indicate a hardware or network media problem.
The first number displayed is a status code from the NIC, of interest to the developers. 
The second number indicates how many packets are retained in the NIC buffer after the 
'cleanup process'.
.PP
.nf
\fIwd0: TX-error, status 0x%x\fR
.fi
A link level error happened during transmit. This should not happen and may 
indicate a physical problem with the network. In rare cases it may be an indication that
the network is really busy. Keep in mind that these interfaces are 10Mbps, more often than 
not connected to a switch carrying Fast Ethernet (100Mbps) or Gigabit Ethernet traffic. The broadcast
traffic on such segments may have bursts that the old interfaces have a hard time keeping up with.
This message is informational.
.PP
.nf
\fIwd0: RX-error, status 0x%x\fR
.fi
A link level error happened during receive. This should not happen but may occur 
under heavy load. The message is informational and will not show unless the verbolse-falg is set.
.PP
.nf
\fIwd0: Bogus packet: status %#x nxpg %#x size %d\fR
.fi
A unusual status code was set by the NIC related to a recieved packet. This should not 
happen, and would be of great interest to developers.
.PP
.nf
\fIwd0: Unable to use IRQ %d (errno %d)\fR
.fi
An interface is already using this  IRQ. 
Network and other ISA interfaces are configured during boot, but the IRQ is assigned at runtime,
when the actual interface is opened. Hence, it's OK to see several interfaces reporting 
the same IRQ at boot time.
However, if the IRQ is already taken when a device is opened, this error message will be emitted.
The conflict may be remedied by closing the offending device, but since the ISA bus does not
provide any standardized mechanism for releasing IRQs, it may be necessary to reboot in order to
reassign an IRQ.

.SH IOCTLs
The driver supports the following IOCTL calls:
.PP
.nf
	NAME		     PARAMETER		PURPOSE
	IOCTL_ETH_ADDR_GET   char[6]		Get MAC address
	IOCTL_ETH_ADDR_SET   char[6]		Set MAC address
	IOCTL_ETH_GETSTAT    struct netif_stat	Get stats from device
.fi
.PP
The 
.I ADDR_SET
ioctl is currently unused and disabled.

.SH FILES
/dev/wd0, /bootopts, /etc/net.cfg, elks/include/arch/ports.h
.SH "SEE ALSO"
.BR ktcp (8),
.BR ne0 (4),
.BR 3c0 (4),
.BR net (8),
.BR bootopts (5).
.SH AUTHOR
Adapted from the ELKS ne2k driver by @pawosm-arm (2020), expanded and partly 
rewritten by @mellvik/TLVC (2022, 2025).
